{"compress":true,"commitItems":[["3e8c943e-3bd1-4a75-b80b-189ce593049e",1521454206963,"",[[1521454177579,["gengmei_pxf@gengmei123.local",[[1,0,"Dalvik ART下，apk的安装与加载流程\n===\n\n\n## 1.什么是APK\n\n　　APK，即Android Package，Android安装包。不同平台的安装文件格式都不同，类似于Windows的安装包是二进制的exe格式，Mac的安装包是dmg格式。APK可以再Android上执行安装，APK的本质是一个Zip压缩包，只是后缀被修改为apk，其中打包了源代码编译出的class.dex、一些图片视屏资源文件和一些Native库文件。APK文件与Zip文件最大的一个不同是APK包含签名文件，用于保证安装包安全不被修改。\n\n## 2.什么是DEX文件和ODEX文件\n\n　　Java卡平台是由源代码编译出的class文件分别运行在不同平台的虚拟机上，由虚拟机屏蔽了不同平台的差异。但是由于Android系统针对手持设备，对Dalvik虚拟机进行了优化，主要包括：\n　　　　（1）将原来class文件进行优化，例如将其中的常量冗余信息进行合并，提供虚拟机解析效率；\n　　　　（2）修改JVM运行时基于栈的数据结构修改为Dalvik基于寄存器的数据结构，数据访问方式更快，运行效率更高。\n　　这种情况下，原来的.class文件就有些不适用了，因此，出现了dex文件格式，它是源代码编译后打包生成的文件。它是APK的一个组成部分。ODEX文件是Dalvik将dex文件中可执行文件class.dex文件解压出来后，存储在本地后生成的。因为Android系统无法直接运行APK文件，需要将其解压后找到class.dex文件后才可以运行，因此在安装时就将其取出放在本地，可以提高应用启动速度。除了这个原因，其实在将class.dex转换成ODEX文件过程中，还根据当前系统进行了优化（直接复制到其他系统不一定可以运行），文件大小会减少，ODEX文件比DEX文件更难反编译，这也在一定程度上提高了安全性，因此在一些系统预安装或系统级应用大多采用了ODEX优化。一般ODEX不直接运行，在Dalvik运行ODEX时，需要通过JIT进行优化，提高运行效率。JIT是一种在运行时同步将字节码转化成机器码的过程，Dalvik直接运行转化后的机器码，这会导致部分的内存和时间开销，但是整体来说，在某些情况下是会提高系统性能的。（有些动态编译器，可能根据经验或尝试编译，优化这一过程，可能运行次数越多，优化效果越好）。\n\n## 3.什么是OAT文件\n\n　　OAT文件是ART运行的文件，是一种二进制可运行文件，包含DEX文件和编译出的本地机器指令文件，其文件格式类似于网络数据报文，包含文件头和文件体，文件头的oatdata、oatexec和oatlastword字段分别描述DEX文件位置和本地机器指令的起止位置。因为OAT文件包含DEX文件，因此比ODEX文件占用空间更大，由于其在安装时经过了ART的处理，ART加载OAT文件后不需要经过处理就可以直接运行，它没有了从字节码转换成机器码的过程，因此运行速度更快。可以理解为JIT进行优化从运行时才解析提前到了安装时解析，安装变慢，运行变快。\n\n## 4.什么是Dalvik和ART\n\n　　Dalvik和ART都是Android运行环境，但是由于Dalvik存在一些不足，ART是在高版本手机上替换Dalvik的。Dalvik和ART是Android平台实现的JAVA虚拟机。用于解析DEX文件、ODEX文件和OAT文件。ART即Android Runtime，Android运行时，由于Android系统运行在不同的设备上，底层硬件不同，Linux系统屏蔽了一些这些系统的细节，但是直接在Linux上开发应用太难，实现成本太高，为了屏蔽Linux的细节，Google创建出了Dalvik和ART，对Linux进行了再一次封装，这样，\n使用Google提供的集成开发环境SDK，就可以轻松开发应用了，Dalvik与ART的关系是ART用来替换Dalvik，现在市场上ART的占用率已经超过了70%。ART是Android应用的运行模式，在这种模式下，Android应用在安装后，会进行一次预编译，将应用安装包中的字节码转换成机器语言存储在本地（系统只能运行二进制程序），这样，应用在运行时，可以直接执行这些二进制程序。相比较于Dalvik来说，Dalvik的做法是在应用安装后，直接将字节码存储起来，在每次运行时，需要将代码编译成机器语言，这样在运行程序时，就比ART慢了一些。ART这样做导致了安装后应用所占的空间更大，安装时间更长，但是对于经常使用的应用，这样做是值得的。\n\n## 5.APK是如何安装的？\n\n　　程序的源代码，首先经过SDK编译成DEX文件，DEX文件和一些资源文件（图片、视频等）、Native Code(C语言等编译出的.so文件)会直接打包进APK。安装APK的过程，其实是安装包解压的过程。资源文件、二进制库等解压后直接存储在本地，DEX文件不仅仅解压，会根据系统的运行环境，采用不同的处理方式，被处理成不同格式的文件存储在本地，等待程序启动调用，这样就完成了应用的安装过程。\n\n**总结：**APK是Android安装包，Dalvik和ART都是Android运行环境，ART是在高版本手机上替换Dalvik的。dex文件是源代码编译后打包生成的文件，是APK的一个组成部分，安装时Dalvik将dex文件中可执行文件class.dex解压存储在本地的文件就是ODEX文件。ART运行生成的文件是OAT。\n\n**Dalvik与ART**比较**：**\n（1）Dalvik和ART是Android平台实现的JAVA虚拟机。用于解析DEX文件、ODEX文件和OAT文件。\n（2）ART解析模式是Android应用在安装后，会进行一次预编译，将应用安装包中的字节码转换成机器语言存储在本地。\n（3）Dalvik解析模式是在应用安装后，直接将字节码存储起来，每次运行时，需要将代码编译成机器语言。\n（4）运行程序时，Dalvik比ART慢，ART安装后应用所占的空间更大，安装时间长。\n\n**ODEX文件与OAT文件比较：**\n（1）Dalvik将APK中的内容转化成ODEX，ART将其转化成OAT。\n（2）ODEX需要通过JIT进行优化，提高运行效率。\n（3）OAT包含DEX文件和编译出的本地机器指令文件，比ODEX文件占用空间大，不需要经过处理就可以直接运行，运行速度快。"]],[0,0],[2672,2672]]],[1521454184173,["gengmei_pxf@gengmei123.local",[[-1,2129,"："]],[2130,2130],[2129,2129]]],[1521454187049,["gengmei_pxf@gengmei123.local",[[1,2131," ："]],[2131,2131],[2133,2133]]],[1521454199646,["gengmei_pxf@gengmei123.local",[[-1,2307,"**：**"]],[2312,2312],[2307,2307]]],[1521454200513,["gengmei_pxf@gengmei123.local",[[1,2307,"："]],[2307,2307],[2308,2308]]],[1521454204088,["gengmei_pxf@gengmei123.local",[[-1,2303,"**"]],[2303,2305],[2303,2303]]],[1521454205344,["gengmei_pxf@gengmei123.local",[[1,2305,"**"]],[2305,2305],[2307,2307]]],[1521454430077,["gengmei_pxf@gengmei123.local",[[1,1927,"\n"]],[1925,1925],[1926,1926]]],[1521454430468,["gengmei_pxf@gengmei123.local",[[1,1928,"\n"]],[1926,1926],[1927,1927]]],[1521454431206,["gengmei_pxf@gengmei123.local",[[1,1927,"![Apk 的打包流程](https://images2018.cnblogs.com/blog/561894/201711/561894-20171129112116909-329161900.png)\n"]],[1927,1927],[2030,2030]]],[1521454433156,["gengmei_pxf@gengmei123.local",[[-1,2031,"\n"]],[2030,2030],[2029,2029]]],[1521455002155,["gengmei_pxf@gengmei123.local",[[-1,426,"提供"]],[428,428],[426,426]]],[1521455004156,["gengmei_pxf@gengmei123.local",[[1,426,"提高"]],[426,426],[428,428]]],[1521455011778,["gengmei_pxf@gengmei123.local",[[1,499,"\n"]],[499,499],[500,500]]],[1521455017162,["gengmei_pxf@gengmei123.local",[[1,500,"\t\t\t"]],[500,500],[503,503]]],[1521455018732,["gengmei_pxf@gengmei123.local",[[-1,500,"\t\t\t"]],[503,503],[500,500]]],[1521455022330,["gengmei_pxf@gengmei123.local",[[-1,387,"　　　　"]],[391,391],[387,387]]],[1521455022618,["gengmei_pxf@gengmei123.local",[[-1,386,"\n"]],[387,387],[386,386]]],[1521455023514,["gengmei_pxf@gengmei123.local",[[1,386,"\n"]],[386,386],[387,387]]],[1521455024322,["gengmei_pxf@gengmei123.local",[[1,387,"\n"]],[387,387],[388,388]]],[1521455024877,["gengmei_pxf@gengmei123.local",[[1,388,"*"]],[388,388],[389,389]]],[1521455029554,["gengmei_pxf@gengmei123.local",[[-1,435,"　　　　"]],[436,439],[435,435]]],[1521455030468,["gengmei_pxf@gengmei123.local",[[1,435,"*"]],[435,435],[436,436]]],[1521455035323,["gengmei_pxf@gengmei123.local",[[-1,387,"\n"]],[388,388],[387,387]]],[1521455036818,["gengmei_pxf@gengmei123.local",[[-1,386,"\n"]],[387,387],[386,386]]],[1521455038081,["gengmei_pxf@gengmei123.local",[[1,386,"\n"]],[386,386],[387,387]]],[1521455039235,["gengmei_pxf@gengmei123.local",[[1,388," "]],[388,388],[389,389]]],[1521455042016,["gengmei_pxf@gengmei123.local",[[1,435,"\n"]],[435,435],[436,436]]],[1521455043043,["gengmei_pxf@gengmei123.local",[[1,437," "]],[437,437],[438,438]]],[1521455047273,["gengmei_pxf@gengmei123.local",[[-1,496,"\n"]],[497,497],[496,496]]],[1521455048777,["gengmei_pxf@gengmei123.local",[[-1,494,"　　"]],[496,496],[494,494]]],[1521455050265,["gengmei_pxf@gengmei123.local",[[-1,493,"\n"]],[494,494],[493,493]]],[1521455051457,["gengmei_pxf@gengmei123.local",[[1,493,"\n"]],[493,493],[494,494]]],[1521455052105,["gengmei_pxf@gengmei123.local",[[1,494,"\n"]],[494,494],[495,495]]],[1521455183458,["gengmei_pxf@gengmei123.local",[[1,563,"\n"]],[563,563],[564,564]]],[1521455184713,["gengmei_pxf@gengmei123.local",[[1,564,"\n"]],[564,564],[565,565]]],[1521455189481,["gengmei_pxf@gengmei123.local",[[1,694,"\n"]],[694,694],[695,695]]],[1521455189993,["gengmei_pxf@gengmei123.local",[[1,695,"\n"]],[695,695],[696,696]]],[1521455222960,["gengmei_pxf@gengmei123.local",[[1,829,"\n"]],[829,829],[830,830]]],[1521455223615,["gengmei_pxf@gengmei123.local",[[1,830,"\n"]],[830,830],[831,831]]],[1521455293366,["gengmei_pxf@gengmei123.local",[[-1,923,"导致"]],[925,925],[923,923]]],[1521455295496,["gengmei_pxf@gengmei123.local",[[1,923,"减少"]],[923,923],[925,925]]],[1521455300845,["gengmei_pxf@gengmei123.local",[[-1,935,"，"]],[936,936],[935,935]]],[1521455301360,["gengmei_pxf@gengmei123.local",[[1,935,"。"]],[935,935],[936,936]]],[1521455301894,["gengmei_pxf@gengmei123.local",[[1,936,"\n"]],[936,936],[937,937]]],[1521455302213,["gengmei_pxf@gengmei123.local",[[1,937,"\n"]],[937,937],[938,938]]],[1521455328468,["gengmei_pxf@gengmei123.local",[[1,495,"\n"]],[494,494],[495,495]]],[1521455340084,["gengmei_pxf@gengmei123.local",[[1,495,"### DEX文件"]],[495,495],[504,504]]],[1521455344545,["gengmei_pxf@gengmei123.local",[[1,575,"\n"]],[574,574],[575,575]]],[1521455346035,["gengmei_pxf@gengmei123.local",[[1,575,"### "]],[575,575],[579,579]]],[1521455355412,["gengmei_pxf@gengmei123.local",[[1,579,"ODEX文件"]],[579,579],[585,585]]],[1521455695536,["gengmei_pxf@gengmei123.local",[[-1,1093,"，"]],[1094,1094],[1093,1093]]],[1521455696588,["gengmei_pxf@gengmei123.local",[[1,1093,"。"]],[1093,1093],[1094,1094]]],[1521455697000,["gengmei_pxf@gengmei123.local",[[1,1094,"\n"]],[1094,1094],[1095,1095]]],[1521455697856,["gengmei_pxf@gengmei123.local",[[1,1095,"\n"]],[1095,1095],[1096,1096]]],[1521455703168,["gengmei_pxf@gengmei123.local",[[-1,1044,"　　"]],[1046,1046],[1044,1044]]],[1521455708591,["gengmei_pxf@gengmei123.local",[[1,1176,"\n"]],[1176,1176],[1177,1177]]],[1521455709143,["gengmei_pxf@gengmei123.local",[[1,1177,"\n"]],[1177,1177],[1178,1178]]],[1521455714949,["gengmei_pxf@gengmei123.local",[[-1,1208,"，"]],[1209,1209],[1208,1208]]],[1521455715386,["gengmei_pxf@gengmei123.local",[[1,1208,"。"]],[1208,1208],[1209,1209]]],[1521455715701,["gengmei_pxf@gengmei123.local",[[1,1209,"\n"]],[1209,1209],[1210,1210]]],[1521455716359,["gengmei_pxf@gengmei123.local",[[1,1210,"\n"]],[1210,1210],[1211,1211]]],[1521455722055,["gengmei_pxf@gengmei123.local",[[1,1281,"\n"]],[1281,1281],[1282,1282]]],[1521455722391,["gengmei_pxf@gengmei123.local",[[1,1282,"\n"]],[1282,1282],[1283,1283]]],[1521455741118,["gengmei_pxf@gengmei123.local",[[-1,1344,"　　"]],[1346,1346],[1344,1344]]],[1521455742416,["gengmei_pxf@gengmei123.local",[[1,1344,"* "]],[1344,1344],[1346,1346]]],[1521455749230,["gengmei_pxf@gengmei123.local",[[1,1408,"\n"]],[1408,1408],[1409,1409]]],[1521455750382,["gengmei_pxf@gengmei123.local",[[1,1409,"\n"]],[1409,1409],[1410,1410]]],[1521455751432,["gengmei_pxf@gengmei123.local",[[1,1410,"* "]],[1410,1410],[1412,1412]]],[1521455763453,["gengmei_pxf@gengmei123.local",[[1,1466,"\n"]],[1466,1466],[1467,1467]]],[1521455764077,["gengmei_pxf@gengmei123.local",[[1,1467,"\n"]],[1467,1467],[1468,1468]]],[1521455765559,["gengmei_pxf@gengmei123.local",[[1,1468,"* "]],[1468,1468],[1470,1470]]],[1521455800260,["gengmei_pxf@gengmei123.local",[[-1,1626,"\n"]],[1627,1627],[1626,1626]]],[1521455804108,["gengmei_pxf@gengmei123.local",[[-1,1657,"，"]],[1658,1658],[1657,1657]]],[1521455804742,["gengmei_pxf@gengmei123.local",[[1,1657,"。"]],[1657,1657],[1658,1658]]],[1521455805243,["gengmei_pxf@gengmei123.local",[[1,1658,"\n"]],[1658,1658],[1659,1659]]],[1521455806403,["gengmei_pxf@gengmei123.local",[[1,1659,"\n"]],[1659,1659],[1660,1660]]],[1521455807589,["gengmei_pxf@gengmei123.local",[[1,1660,"* "]],[1660,1660],[1662,1662]]],[1521455813523,["gengmei_pxf@gengmei123.local",[[1,1711,"\n"]],[1711,1711],[1712,1712]]],[1521455814227,["gengmei_pxf@gengmei123.local",[[1,1712,"\n"]],[1712,1712],[1713,1713]]],[1521455831482,["gengmei_pxf@gengmei123.local",[[1,1823,"\n"]],[1823,1823],[1824,1824]]],[1521455832028,["gengmei_pxf@gengmei123.local",[[1,1824,"\n"]],[1824,1824],[1825,1825]]],[1521455833421,["gengmei_pxf@gengmei123.local",[[1,1825,"* "]],[1825,1825],[1827,1827]]],[1521455835637,["gengmei_pxf@gengmei123.local",[[1,1713,"* "]],[1713,1713],[1715,1715]]],[1521455865043,["gengmei_pxf@gengmei123.local",[[1,1909,"\n"]],[1909,1909],[1910,1910]]],[1521455865458,["gengmei_pxf@gengmei123.local",[[1,1910,"\n"]],[1910,1910],[1911,1911]]],[1521455866397,["gengmei_pxf@gengmei123.local",[[1,1911,"* "]],[1911,1911],[1913,1913]]],[1521455880401,["gengmei_pxf@gengmei123.local",[[1,1044,"* "]],[1044,1044],[1046,1046]]],[1521455882236,["gengmei_pxf@gengmei123.local",[[1,1096,"* "]],[1096,1096],[1098,1098]]],[1521455883332,["gengmei_pxf@gengmei123.local",[[1,1182,"* "]],[1182,1182],[1184,1184]]],[1521455884532,["gengmei_pxf@gengmei123.local",[[1,1217,"* "]],[1217,1217],[1219,1219]]],[1521455886004,["gengmei_pxf@gengmei123.local",[[1,1291,"* "]],[1291,1291],[1293,1293]]],[1521455892340,["gengmei_pxf@gengmei123.local",[[1,586,"* "]],[586,586],[588,588]]],[1521455893755,["gengmei_pxf@gengmei123.local",[[1,719,"* "]],[719,719],[721,721]]],[1521455894908,["gengmei_pxf@gengmei123.local",[[1,856,"* "]],[856,856],[858,858]]],[1521455898468,["gengmei_pxf@gengmei123.local",[[1,505,"* "]],[505,505],[507,507]]],[1521456544160,["gengmei_pxf@gengmei123.local",[[-1,2103,"　　"]],[2105,2105],[2103,2103]]],[1521456547044,["gengmei_pxf@gengmei123.local",[[1,2103,"* "]],[2103,2103],[2105,2105]]],[1521456554504,["gengmei_pxf@gengmei123.local",[[1,2185,"\n"]],[2185,2185],[2186,2186]]],[1521456555784,["gengmei_pxf@gengmei123.local",[[1,2186,"\n"]],[2186,2186],[2187,2187]]],[1521456557251,["gengmei_pxf@gengmei123.local",[[1,2187,"* "]],[2187,2187],[2189,2189]]],[1521456565522,["gengmei_pxf@gengmei123.local",[[1,2210,"\n"]],[2210,2210],[2211,2211]]],[1521456565848,["gengmei_pxf@gengmei123.local",[[1,2211,"\n"]],[2211,2211],[2212,2212]]],[1521456566898,["gengmei_pxf@gengmei123.local",[[1,2212,"* "]],[2212,2212],[2214,2214]]]]]]}